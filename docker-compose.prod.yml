# GEKO-AI Platform - Production Docker Compose
# 
# Usage:  docker-compose -f docker-compose.prod.yml up -d
#
# Differences from dev:
# - Health checks more strict
# - Logging configured for production
# - Resource limits set
# - No debug ports exposed
# - Database backups configured


services:
  postgres:
    image: postgres:16-alpine
    container_name:  geko-postgres
    restart:  always
    environment:
      POSTGRES_USER: ${DB_USER:-geko}
      POSTGRES_PASSWORD: ${DB_PASSWORD}
      POSTGRES_DB: ${DB_NAME:-geko_ai}
    ports:
      - "5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./infra/postgres/init.sql:/docker-entrypoint-initdb.d/01_init.sql
      - ./backups:/backups
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${DB_USER:-geko}"]
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 20s
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 4G
        reservations:
          cpus: '1'
          memory:  2G
    networks:
      - geko-network
    logging:
      driver: "json-file"
      options:
        max-size:  "50m"
        max-file: "10"

  mongodb:
    image: mongo:7-alpine
    container_name: geko-mongodb
    restart: always
    environment:
      MONGO_INITDB_ROOT_USERNAME: ${MONGO_USER}
      MONGO_INITDB_ROOT_PASSWORD: ${MONGO_PASSWORD}
    volumes: 
      - mongodb_data:/data/db
    healthcheck:
      test: ["CMD", "mongosh", "--eval", "db.adminCommand('ping')"]
      interval: 10s
      timeout: 5s
      retries: 10
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 4G
        reservations:
          cpus: '1'
          memory: 2G
    networks: 
      - geko-network
    logging:
      driver: "json-file"
      options: 
        max-size: "50m"
        max-file: "10"

  redis: 
    image: redis:7-alpine
    container_name: geko-redis
    restart: always
    command: redis-server --appendonly yes --requirepass ${REDIS_PASSWORD} --maxmemory 2gb
    volumes:
      - redis_data:/data
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout:  5s
      retries:  10
    deploy:
      resources:
        limits:
          cpus: '1'
          memory: 2G
        reservations:
          cpus: '0.5'
          memory: 1G
    networks: 
      - geko-network
    logging:
      driver: "json-file"
      options: 
        max-size: "50m"
        max-file: "10"

  librechat: 
    build: 
      context: ./services/librechat-backend
      dockerfile: Dockerfile
    image: geko-librechat:latest
    container_name: geko-librechat
    restart: always
    environment:
      NODE_ENV: production
      PORT: 3080
      MONGO_URI: mongodb://${MONGO_USER}:${MONGO_PASSWORD}@mongodb:27017/librechat?authSource=admin
      OPENAI_API_KEY: ${OPENAI_API_KEY}
      ANTHROPIC_API_KEY: ${ANTHROPIC_API_KEY}
      GOOGLE_API_KEY: ${GOOGLE_API_KEY}
      DEEPSEEK_API_KEY: ${DEEPSEEK_API_KEY}
      MEILI_NO_ANALYTICS: "true"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3080/health"]
      interval: 30s
      timeout: 10s
      retries: 10
      start_period: 60s
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 4G
        reservations:
          cpus: '1'
          memory: 2G
    depends_on:
      mongodb:
        condition: service_healthy
    networks:
      - geko-network
    logging:
      driver: "json-file"
      options:
        max-size:  "50m"
        max-file: "10"

  geko-services:
    build: 
      context: .
      dockerfile: Dockerfile
      args:
        NODE_ENV:  production
    image: geko-ai:latest
    container_name: geko-services
    restart: always
    environment:
      NODE_ENV: production
      LOG_LEVEL: info
      DB_HOST: postgres
      DB_PASSWORD: ${DB_PASSWORD}
      MONGO_PASSWORD: ${MONGO_PASSWORD}
      REDIS_PASSWORD: ${REDIS_PASSWORD}
      JWT_SECRET: ${JWT_SECRET}
      OPENAI_API_KEY: ${OPENAI_API_KEY}
      ANTHROPIC_API_KEY: ${ANTHROPIC_API_KEY}
      STRIPE_SECRET_KEY: ${STRIPE_SECRET_KEY}
    ports:
      - "3002:3002"  # Gateway only exposed
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3002/health"]
      interval: 30s
      timeout: 10s
      retries: 10
      start_period: 60s
    deploy:
      resources:
        limits:
          cpus: '4'
          memory: 8G
        reservations:
          cpus: '2'
          memory: 4G
    depends_on:
      postgres:
        condition: service_healthy
      mongodb:
        condition: service_healthy
      redis:
        condition:  service_healthy
      librechat:
        condition: service_healthy
    networks:
      - geko-network
    logging:
      driver:  "json-file"
      options:
        max-size: "100m"
        max-file: "20"

volumes:
  postgres_data: 
  mongodb_data:
  redis_data:

networks:
  geko-network: 
    driver: bridge